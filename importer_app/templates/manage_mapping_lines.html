{% extends "base.html" %}

{% block title %}Manage Lines for {{ mapping_rule.mapping_name }}{% endblock %}

{% block head_styles %}
<style>
    .page-container { max-width: 95%; margin: 20px auto; }
    .section { border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #f9f9f9; margin-bottom: 25px; }
    h3 { margin-top: 0; text-transform: capitalize; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9em; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; vertical-align: middle; word-wrap: break-word; }
    th { background-color: #f2f6fc; }
    .rule-table input, .rule-table select, .details-section input, .details-section textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border; }
    .button-bar { margin: 20px 0; display: flex; justify-content: flex-end; gap: 10px; }
    .required-field::after { content: ' *'; color: red; }
    .hidden { display: none; }
    .disabled-form { opacity: 0.5; pointer-events: none; }
    .sample-output-cell { color: #0056b3; font-weight: bold; font-style: italic; transition: all 0.2s ease-in-out; }
    .formula-builder { display: flex; flex-direction: column; gap: 5px; }
    .formula-builder textarea { width: 100%; height: 60px; }
    .form-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: center; }
    .form-group { margin: 0; }
    /* Styles for validation feedback */
    .output-warning { color: #fd7e14 !important; border-left: 3px solid #fd7e14; }
    .output-error { color: #dc3545 !important; border-left: 3px solid #dc3545; font-weight: bold; }
    
    /* Ignore Rule Section Styling */
    .ignore-rules-table { margin-top: 15px; }
    .ignore-rules-table td { position: relative; }
    .delete-ignore-rule {
        position: absolute;
        top: 50%;
        right: 5px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #dc3545;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2em;
    }

    /* Styles for core rules */
    .core-rule-row {
        background-color: #f0f0f0; /* Light grey background */
        opacity: 0.8; /* Slightly faded */
    }
    .core-rule-row input,
    .core-rule-row select,
    .core-rule-row textarea {
        cursor: not-allowed;
        background-color: #e9ecef; /* Slightly darker input background */
    }
    .core-rule-row .btn-delete-row {
        display: none; /* Hide delete button for core rules */
    }
    /* Disable other buttons in core rule rows, but not the reset button */
    .core-rule-row button:not(.reset-button) {
        cursor: not-allowed;
        opacity: 0.5;
        pointer-events: none;
    }
    .core-rule-row .reset-button {
        background-color: #007bff; /* Keep reset button visible and styled */
        color: white;
        pointer-events: auto; /* Ensure it's clickable */
        opacity: 1; /* Ensure it's not faded */
    }

    /* Tooltip styles for rule name notes */
    .rule-name-with-note {
        display: flex;
        align-items: center;
        position: relative;
    }
    .tooltip-icon {
        margin-left: 5px;
        cursor: help;
        color: #007bff;
        font-weight: bold;
        font-size: 0.9em;
    }
    .tooltip-text {
        visibility: hidden;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 5px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%; /* Position above the icon */
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
    }
    .rule-name-with-note:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <a href="{{ url_for('supplier_setup.manage_supplier', supplier_id=mapping_rule.supplier_id) }}" class="button" style="background-color: #6c757d;">&larr; Back to Supplier</a>
    <h1>Manage Mapping Rules</h1>

    <form id="mapping-lines-form" action="{{ url_for('mapping_manager.save_mapping_lines_set') }}" method="POST">
        <input type="hidden" name="mapping_id" value="{{ mapping_rule.id }}">

        <div class="section details-section">
            <h3>Mapping Details</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="mapping_name" class="required-field">Mapping Name</label>
                    <input type="text" id="mapping_name" name="mapping_name" value="{{ mapping_rule.mapping_name or '' }}" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="1">{{ mapping_rule.description or '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Upload a Sample CSV</h3>
            <p>Upload a sample CSV file to enable the form and populate column dropdowns for accurate mapping.</p>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <input type="file" id="csv-file-input" accept=".csv" style="flex-grow: 1;">
                <button type="button" class="button" onclick="processCsvFile()">Process Sample CSV</button>
            </div>
            <div id="sample-data-container" class="{% if not sample_csv_headers %}hidden{% endif %}">
                <h4>Sample Data Preview:</h4>
                <table id="sample-data-table">
                    <thead><tr>{% for header in sample_csv_headers %}<th>{{ header }}</th>{% endfor %}</tr></thead>
                    <tbody><tr>{% for cell in sample_csv_first_row %}<td>{{ cell }}</td>{% endfor %}</tr></tbody>
                </table>
                <div id="ignore-rule-warning" class="hidden" style="color: #d9534f; font-weight: bold; margin-top: 10px;">
                    Warning: The current sample data row matches an ignore rule.
                </div>
            </div>
        </div>

        <div id="mapping-form-container" class="{% if not sample_csv_headers %}disabled-form{% endif %}">
            <div class="button-bar">
                <button type="submit" class="button">Save All Changes</button>
                <button type="button" class="button btn-danger" onclick="resetAllMappingLines()">Reset All Lines</button>
            </div>

            {% for role_key, rules in full_rule_set.items() %}
            <div class="section">
                <h3>{{ role_key.replace('_', ' ') }} Rules</h3>
                <table class="rule-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Destination Field</th>
                            <th style="width: 12%;">Source Type</th>
                            <th>Source Details</th>
                            <th style="width: 18%;">Transformation</th>
                            <th style="width: 15%;">Sample Output</th>
                            <th style="width: 8%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in rules %}
                            {# Add a class to the row if it's a base rule and pass is_base_rule data #}
                            <tr data-role="{{ rule.field_role }}" data-name="{{ rule.name }}" data-original-id="{{ rule.id }}"
                                data-is-base-rule="{{ 'true' if rule.is_base_rule else 'false' }}"
                                class="{{ 'core-rule-row' if rule.is_base_rule }}">
                                <input type="hidden" name="rules.{{ rule.id }}.id" value="{{ rule.id }}">
                                <input type="hidden" name="rules.{{ rule.id }}.field_role" value="{{ rule.field_role }}">
                                <input type="hidden" name="rules.{{ rule.id }}.name" value="{{ rule.name }}">
                                <input type="hidden" name="rules.{{ rule.id }}.display_name" value="{{ rule.display_name }}">
                                <td class="{{ 'required-field' if rule.required }} rule-display-name">
                                    <div class="rule-name-with-note">
                                        <span>{{ rule.display_name }}</span>
                                        {% if rule.notes %}
                                            <div class="tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltip-text">{{ rule.notes }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% if rule.name == 'billing_month' %}
                                <td colspan="2">
                                    <input type="hidden" name="rules.{{ rule.id }}.source_type" value="Text Override">
                                    <select name="rules.{{ rule.id }}.static_value" onchange="updateRowOnInputChange(this)"
                                            {% if rule.is_base_rule %}disabled{% endif %}>
                                        <option value="advance" {% if rule.static_value == 'advance' %}selected{% endif %}>Billed in Advance</option>
                                        <option value="arrears" {% if rule.static_value == 'arrears' %}selected{% endif %}>Billed in Arrears</option>
                                        <option value="current" {% if rule.static_value == 'current' %}selected{% endif %}>Current</option>
                                    </select>
                                </td>
                                {% else %}
                                <td>
                                    <select name="rules.{{ rule.id }}.source_type" class="source-type-select" onchange="updateRowOnInputChange(this)"
                                            {% if rule.is_base_rule %}disabled{% endif %}>
                                        {% for type_option in (rule.source_type_options or '').split(',') %}
                                            <option value="{{ type_option }}" {% if rule.source_type == type_option %}selected{% endif %}>{{ type_option }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <div class="source-input csv-input {% if rule.source_type != 'CSV' %}hidden{% endif %}">
                                        <select name="rules.{{ rule.id }}.source_csv_column" class="csv-header-dropdown" onchange="updateRowOnInputChange(this)"
                                                {% if rule.is_base_rule %}disabled{% endif %}>
                                            <option value="">-- Select Column --</option>
                                            {% for header in sample_csv_headers %}<option value="{{ header }}" {% if rule.source_csv_column == header %}selected{% endif %}>{{ header }}</option>{% endfor %}
                                        </select>
                                    </div>
                                    <div class="source-input csvformula-input {% if rule.source_type != 'CSV Formula' %}hidden{% endif %}">
                                        <div class="formula-builder">
                                            <select multiple class="csv-header-dropdown" onchange="insertColumnIntoFormula(this, 'formula-textarea-{{ rule.id }}')"
                                                    {% if rule.is_base_rule %}disabled{% endif %}>
                                                <option value="">-- Insert Column(s) --</option>
                                                {% for header in sample_csv_headers %}<option value="{{ header }}">{{ header }}</option>{% endfor %}
                                            </select>
                                            <textarea id="formula-textarea-{{ rule.id }}" name="rules.{{ rule.id }}.formula_template" placeholder="Build formula using {Column Name}" onchange="updateRowOnInputChange(this)" onkeyup="updateRowOnInputChange(this)"
                                                      {% if rule.is_base_rule %}disabled{% endif %}>{{ rule.formula_template or '' }}</textarea>
                                        </div>
                                    </div>
                                    <div class="source-input textoverride-input {% if rule.source_type != 'Text Override' %}hidden{% endif %}">
                                        <input type="text" name="rules.{{ rule.id }}.static_value" value="{{ rule.static_value or '' }}" onkeyup="updateRowOnInputChange(this)"
                                               {% if rule.is_base_rule %}disabled{% endif %}>
                                    </div>
                                    <div class="source-input link-input {% if rule.source_type != 'Link' %}hidden{% endif %}">
                                        <p><strong>Source Column for Lookup:</strong></p>
                                        <select name="rules.{{ rule.id }}.source_csv_column" class="csv-header-dropdown" onchange="updateRowOnInputChange(this)"
                                                {% if rule.is_base_rule %}disabled{% endif %}>
                                            <option value="">-- Select Column --</option>
                                            {% for header in sample_csv_headers %}<option value="{{ header }}" {% if rule.source_csv_column == header %}selected{% endif %}>{{ header }}</option>{% endfor %}
                                        </select>
                                        <p style="margin-top:10px;">Links to Table: <strong>{{ rule.link_table_lookup or 'N/A' }}</strong></p>
                                        <p>Using Field: <strong>{{ rule.link_field_lookup or 'N/A' }}</strong></p>
                                    </div>
                                </td>
                                {% endif %}
                                <td class="transformation-cell">
                                    <select name="rules.{{ rule.id }}.transformation" onchange="updateRowOnInputChange(this)"
                                            {% if rule.is_base_rule %}disabled{% endif %}>
                                        {% for t_option in rule.allowed_transformations %}
                                            <option value="{{ t_option }}" {% if rule.transformation == t_option %}selected{% endif %}>{{ t_option }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="text" name="rules.{{ rule.id }}.transformation_args" value="{{ rule.transformation_args or '' }}" placeholder="Argument (e.g., date format)" style="margin-top: 5px;" onkeyup="updateRowOnInputChange(this)"
                                           {% if rule.is_base_rule %}disabled{% endif %}>
                                </td>
                                <td class="sample-output-cell" id="preview-{{ rule.id }}">(Transformed Value)</td>
                                <td>
                                    <button type="button" onclick="resetRow(this)" class="reset-button"
                                            {% if rule.is_base_rule %}disabled{% endif %}>Reset</button>
                                </td>
                            </tr>
                            {# The 'is_hidden' check is removed from the outer loop, as the backend should filter this.
                                If `rule.is_hidden` is true, the row will still be rendered but its inputs will be disabled. #}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
            <div class="section ignore-rules-section">
                <h3>Ignore Rules</h3>
                <p style="margin-bottom: 10px;">Add rules to skip processing specific rows from the CSV file.</p>
                <div id="ignore-rules-container">
                    {% for rule in existing_ignore_rules %}
                    <div class="form-grid" id="ignore-rule-{{ rule.id }}">
                        <input type="hidden" name="ignore_rules.{{ rule.id }}.id" value="{{ rule.id }}">
                        <div class="form-group">
                            <label>Source Column</label>
                            <select name="ignore_rules.{{ rule.id }}.source_csv_column" class="csv-header-dropdown">
                                <option value="">-- Select Column --</option>
                                {% for header in sample_csv_headers %}<option value="{{ header }}" {% if rule.source_csv_column == header %}selected{% endif %}>{{ header }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                            <div style="flex-grow: 1;">
                                <label>Ignore if value is</label>
                                <input type="text" name="ignore_rules.{{ rule.id }}.ignore_match" value="{{ rule.ignore_match or '' }}" placeholder="e.g. 'Cancelled' or 'Fixed Line Voice'">
                            </div>
                            <button type="button" class="button" onclick="removeIgnoreRule(this)">Remove</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="button-bar" style="justify-content: flex-start;">
                    <button type="button" class="button" onclick="addIgnoreRule()">Add Ignore Rule</button>
                </div>
            </div>
            <div class="button-bar"><button type="submit" class="button">Save All Changes</button></div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const MAPPING_ID = {{ mapping_rule.id }};
        let sampleHeaders = {{ sample_csv_headers|tojson }};
        let sampleFirstRow = {{ sample_csv_first_row|tojson }};
        const formContainer = document.getElementById('mapping-form-container');
        const existingIgnoreRules = {{ existing_ignore_rules|tojson }};
        const masterRulesData = {{ full_rule_set|tojson }};
        const ignoreRulesContainer = document.getElementById('ignore-rules-container');
        const mappingLinesForm = document.getElementById('mapping-lines-form');

        // --- Core UI Logic Functions ---
        window.updateRowOnInputChange = function(element) {
            const row = element.closest('tr');
            if (!row) return;
            toggleSourceInputs(row);
            updateSampleOutput(row);
        };

        function toggleSourceInputs(row) {
            const sourceTypeSelect = row.querySelector('.source-type-select');
            if (!sourceTypeSelect) return;
            const selectedType = sourceTypeSelect.value.toLowerCase().replace(/ /g, '');
            row.querySelectorAll('.source-input').forEach(input => input.classList.add('hidden'));
            const target = row.querySelector(`.${selectedType}-input`);
            if (target) target.classList.remove('hidden');
        }

        function getRawValue(row) {
            let value = '';
            if (!sampleHeaders || !sampleFirstRow) return value;
            const choiceSelect = row.querySelector('td[colspan="2"] select');
            if (choiceSelect) { return choiceSelect.value; }
            const sourceTypeSelect = row.querySelector('.source-type-select');
            if (!sourceTypeSelect) return '';
            const sourceType = sourceTypeSelect.value;
            if (sourceType === 'CSV' || sourceType === 'Link') {
                const selectedHeader = row.querySelector('.csv-header-dropdown').value;
                const headerIndex = sampleHeaders.indexOf(selectedHeader);
                if (headerIndex !== -1) value = sampleFirstRow[headerIndex];
            } else if (sourceType === 'CSV Formula') {
                let formula = row.querySelector('.formula-builder textarea').value;
                let context = Object.fromEntries(sampleHeaders.map((h, i) => [h, sampleFirstRow[i]]));
                value = formula.replace(/\{([^}]+)\}/g, (match, headerName) => {
                    return context[headerName.trim()] !== undefined ? context[headerName.trim()] : match;
                });
            } else if (sourceType === 'Text Override') {
                value = row.querySelector('input[name$=".static_value"]').value;
            }
            return value;
        }

        async function updateSampleOutput(row) {
            const outputCell = row.querySelector('.sample-output-cell');
            if (!outputCell || !sampleHeaders.length) return;
            outputCell.textContent = '...'; // Show loading indicator
            outputCell.classList.remove('output-warning', 'output-error');
            outputCell.title = '';
            const sourceTypeSelect = row.querySelector('.source-type-select');
            const sourceType = sourceTypeSelect ? sourceTypeSelect.value : (row.querySelector('input[name$=".name"][value="billing_month"]') ? 'Text Override' : 'None');
            
            const rawValue = getRawValue(row);
            if (sourceType === 'Link') {
                outputCell.textContent = rawValue ? `Find ID for: "${rawValue}"` : '(Select a source column)';
                outputCell.title = "During import, the system will find the database ID for this value.";
                return;
            }
            const transformSelect = row.querySelector('select[name$=".transformation"]');
            const transformation = transformSelect ? transformSelect.value : 'None';
            const argsInput = row.querySelector('input[name$=".transformation_args']');
            const transformationArgs = argsInput ? argsInput.value : '';
            const destinationField = row.dataset.name;
            const fieldRole = row.dataset.role;

            if (transformation === 'None' || !rawValue) {
                outputCell.textContent = rawValue; // Display raw value if no transformation or no raw value
                return;
            }
            
            try {
                const response = await fetch("{{ url_for('mapping_manager.transform_preview') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_value: rawValue,
                        transformation: transformation,
                        transformation_args: transformationArgs,
                        destination_field: destinationField,
                        field_role: fieldRole
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    // Display the transformed_value from the API response
                    outputCell.textContent = result.transformed_value;
                    if (result.validation_status && result.validation_status !== 'ok') {
                        outputCell.classList.add('output-' + result.validation_status);
                    }
                    outputCell.title = result.validation_message || '';
                } else {
                    outputCell.textContent = `Error: ${result.error}`;
                    outputCell.classList.add('output-error');
                    outputCell.title = `API Error: ${result.error}`;
                }
            } catch (error) {
                outputCell.textContent = 'Error calling API';
                outputCell.classList.add('output-error');
                outputCell.title = `Fetch Error: ${error}`;
            }
        }
        
        function updateAllCsvDropdowns() {
            const dropdowns = document.querySelectorAll('.csv-header-dropdown');
            dropdowns.forEach(dropdown => {
                const selected = dropdown.value;
                dropdown.innerHTML = '<option value="">-- Select Column --</option>' + sampleHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
                if (selected) {
                    dropdown.value = selected;
                }
            });
        }
        
        function updateSampleDataPreview(headers, firstRow) {
            const tableHead = document.querySelector('#sample-data-table thead tr');
            const tableBody = document.querySelector('#sample-data-table tbody tr');
            
            tableHead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            tableBody.innerHTML = firstRow.map(c => `<td>${c}</td>`).join('');
            
            document.getElementById('sample-data-container').classList.remove('hidden');
        }

        window.processCsvFile = function() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to process.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const firstRow = lines[1].split(',').map(c => c.trim());
                    
                    sampleHeaders = headers;
                    sampleFirstRow = firstRow;

                    updateSampleDataPreview(sampleHeaders, sampleFirstRow);
                    updateAllCsvDropdowns();
                    formContainer.classList.remove('disabled-form');

                    document.querySelectorAll('.rule-table tbody tr').forEach(row => updateSampleOutput(row));
                    saveSampleDataToDb(MAPPING_ID, headers, firstRow);

                    // Check for ignore rule matches
                    checkIgnoreRules(firstRow, headers);

                } catch (error) {
                    alert('Failed to parse CSV. Please check file format.');
                    console.error('CSV Parsing Error:', error);
                }
            };
            reader.readAsText(file);
        };
        
        async function saveSampleDataToDb(mappingId, headers, firstRow) {
            try {
                const response = await fetch("{{ url_for('mapping_manager.save_sample_data') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `mapping_id=${mappingId}&headers_json=${encodeURIComponent(JSON.stringify(headers))}&first_row_json=${encodeURIComponent(JSON.stringify(firstRow))}`
                });
                const result = await response.json();
                if (result.status !== 'success') {
                    console.error('Failed to save sample data to database:', result.message);
                }
            } catch (error) {
                console.error('Error saving sample data:', error);
            }
        }
        
        function checkIgnoreRules(firstRow, headers) {
            const warningBox = document.getElementById('ignore-rule-warning');
            let isIgnored = false;
            existingIgnoreRules.forEach(rule => {
                const colIndex = headers.indexOf(rule.source_csv_column);
                if (colIndex !== -1 && firstRow[colIndex] === rule.ignore_match) {
                    isIgnored = true;
                }
            });
            if (isIgnored) {
                warningBox.classList.remove('hidden');
            } else {
                warningBox.classList.add('hidden');
            }
        }
        
        window.resetRow = function(button) {
            const row = button.closest('tr');
            const originalId = row.dataset.originalId;
            // Find the original rule from masterRulesData using role and originalId
            let originalRule = null;
            for (const roleKey in masterRulesData) {
                const found = masterRulesData[roleKey].find(r => r.id == originalId);
                if (found) {
                    originalRule = found;
                    break;
                }
            }
            
            if (!originalRule) {
                console.warn("Original rule not found for resetRow:", originalId);
                return;
            }

            const sourceTypeSelect = row.querySelector('.source-type-select');
            if (sourceTypeSelect) sourceTypeSelect.value = originalRule.source_type || 'None';

            const csvDropdown = row.querySelector('select[name$=".source_csv_column"]');
            if (csvDropdown) csvDropdown.value = originalRule.source_csv_column || '';

            const formulaTextarea = row.querySelector('textarea[name$=".formula_template"]');
            if (formulaTextarea) formulaTextarea.value = originalRule.formula_template || '';

            const staticValueInput = row.querySelector('input[name$=".static_value']');
            if (staticValueInput) staticValueInput.value = originalRule.static_value || '';

            const transformSelect = row.querySelector('select[name$=".transformation"]');
            if (transformSelect) transformSelect.value = originalRule.transformation || 'None';

            const transformArgsInput = row.querySelector('input[name$=".transformation_args"]');
            if (transformArgsInput) transformArgsInput.value = originalRule.transformation_args || '';
            
            // For billing_month, directly update the select
            const billingMonthSelect = row.querySelector('select[name$=".static_value"]');
            if (billingMonthSelect && originalRule.name === 'billing_month') {
                billingMonthSelect.value = originalRule.static_value || 'current';
            }

            updateRowOnInputChange(sourceTypeSelect || transformSelect || billingMonthSelect);
        }

        // --- New: Reset All Lines Functionality ---
        window.resetAllMappingLines = async function() {
            const confirmation = await showCustomConfirm(
                'Are you sure you want to reset ALL mapping lines? This will delete all existing lines ' +
                'and replace them with the current state of the form. This action cannot be undone.'
            );
            if (!confirmation) {
                return;
            }

            // Collect all form data
            const formData = new FormData(mappingLinesForm);
            const data = new URLSearchParams(formData).toString(); // Convert to x-www-form-urlencoded

            try {
                const response = await fetch("{{ url_for('mapping_manager.reset_all_mapping_lines') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: data
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    // Reload the page to reflect the new state from the database
                    window.location.reload(); 
                } else {
                    alert(`Error resetting lines: ${result.message || 'Unknown error'}`);
                    console.error('Error resetting lines:', result);
                }
            } catch (error) {
                alert(`Failed to reset lines: ${error.message}`);
                console.error('Fetch error during reset:', error);
            }
        };

        // --- Ignore Rules Logic ---
        let ignoreRuleCounter = existingIgnoreRules.length;

        window.addIgnoreRule = function() {
            ignoreRuleCounter++;
            const newRuleId = 'new_' + ignoreRuleCounter;
            const div = document.createElement('div');
            div.className = 'form-grid';
            div.id = `ignore-rule-${newRuleId}`;
            div.innerHTML = `
                <input type="hidden" name="ignore_rules.${newRuleId}.id" value="${newRuleId}">
                <div class="form-group">
                    <label>Source Column</label>
                    <select name="ignore_rules.${newRuleId}.source_csv_column" class="csv-header-dropdown">
                        <option value="">-- Select Column --</option>
                        ${sampleHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                    <div style="flex-grow: 1;">
                        <label>Ignore if value is</label>
                        <input type="text" name="ignore_rules.${newRuleId}.ignore_match" placeholder="e.g. 'Cancelled' or 'Fixed Line Voice'">
                    </div>
                    <button type="button" class="button" onclick="removeIgnoreRule(this)">Remove</button>
                </div>
            `;
            ignoreRulesContainer.appendChild(div);
        }

        window.removeIgnoreRule = function(button) {
            const ruleDiv = button.closest('.form-grid');
            if (ruleDiv) {
                ruleDiv.remove();
            }
        }
        
        window.insertColumnIntoFormula = function(selectElement, textareaId) {
            const textarea = document.getElementById(textareaId);
            const selectedOptions = Array.from(selectElement.selectedOptions);
            const newText = selectedOptions.map(option => `{${option.value}}`).join('');
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + newText + text.substring(end);
            selectElement.selectedIndex = -1; // Clear selection
            textarea.focus();
            updateSampleOutput(textarea.closest('tr'));
        }

        // --- Custom Alert/Confirm Modals (replacing window.alert/confirm) ---
        let customAlertDialog;
        let customConfirmDialog;
        let customConfirmResolve;

        function initCustomDialogs() {
            // Alert Dialog
            customAlertDialog = document.createElement('div');
            customAlertDialog.id = 'custom-alert-dialog';
            customAlertDialog.className = 'modal';
            customAlertDialog.innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="customAlertDialog.style.display='none';">&times;</span>
                    <h2 style="font-size: 1.5em; margin-bottom: 15px;">Message</h2>
                    <p id="custom-alert-message" style="margin-bottom: 25px;"></p>
                    <div class="modal-button-bar" style="justify-content: center;">
                        <button class="button" onclick="customAlertDialog.style.display='none';">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(customAlertDialog);

            // Confirm Dialog
            customConfirmDialog = document.createElement('div');
            customConfirmDialog.id = 'custom-confirm-dialog';
            customConfirmDialog.className = 'modal';
            customConfirmDialog.innerHTML = `
                <div class="modal-content">
                    <span class="close-button" onclick="customConfirmDialog.style.display='none'; customConfirmResolve(false);">&times;</span>
                    <h2 style="font-size: 1.5em; margin-bottom: 15px;">Confirmation</h2>
                    <p id="custom-confirm-message" style="margin-bottom: 25px;"></p>
                    <div class="modal-button-bar" style="justify-content: center;">
                        <button class="button" onclick="customConfirmDialog.style.display='none'; customConfirmResolve(true);">Yes</button>
                        <button class="button btn-secondary" onclick="customConfirmDialog.style.display='none'; customConfirmResolve(false);">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(customConfirmDialog);

            // Override native alerts/confirms (optional, but good for consistency)
            window.alert = function(message) {
                document.getElementById('custom-alert-message').textContent = message;
                customAlertDialog.style.display = 'block';
            };
            window.confirm = function(message) {
                return new Promise(resolve => {
                    document.getElementById('custom-confirm-message').textContent = message;
                    customConfirmResolve = resolve;
                    customConfirmDialog.style.display = 'block';
                });
            };
        }

        async function showCustomConfirm(message) {
            return await window.confirm(message);
        }
        // --- End Custom Alert/Confirm Modals ---

        // --- INITIAL PAGE SETUP ---
        if (sampleHeaders && sampleHeaders.length > 0) {
            formContainer.classList.remove('disabled-form');
        } else {
            formContainer.classList.add('disabled-form');
        }
        document.querySelectorAll('.rule-table tr').forEach(row => toggleSourceInputs(row));

        // CORRECTED LOGIC: Initialize dropdown values first, then trigger the preview update for each row.
        // This is done by Jinja now, so we just need to run the preview updates.
        document.querySelectorAll('.rule-table tbody tr').forEach(row => {
            updateSampleOutput(row);
        });

        // Initialize custom dialogs
        initCustomDialogs();
    });
</script>
{% endblock %}
